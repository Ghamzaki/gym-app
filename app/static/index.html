<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym RBAC Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f2f5; }
        .app-header { background-color: #3f51b5; color: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { margin: 0; font-size: 1.5em; }
        .auth-status { font-size: 0.9em; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .content { min-height: 400px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 4px; margin-top: 20px; }
        .nav button { background: none; border: none; color: #3f51b5; padding: 10px 15px; cursor: pointer; font-weight: 600; border-radius: 4px; margin-left: 10px; transition: background-color 0.2s; }
        .nav button:hover, .nav button.active { background-color: #e8eaf6; }
        form { display: flex; flex-direction: column; gap: 10px; padding: 15px 0; }
        input[type="text"], input[type="email"], input[type="password"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button.primary { background-color: #3f51b5; }
        button.danger { background-color: #f44336; }
        button:hover { opacity: 0.9; }
        .message { padding: 10px; margin-top: 15px; border-radius: 4px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .service-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .service-item { background: #f9f9f9; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div class="app-header">
        <h1>üèãÔ∏è Gym Portal</h1>
        <div id="auth-status" class="auth-status"></div>
    </div>

    <div class="container">
        <div class="nav" id="navigation">
            </div>

        <div id="main-content" class="content">
            </div>

        <div id="message-area" class="message" style="display:none;"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = ''; // Same domain, using relative path
        let currentUser = null;
        let userRole = null;
        let accessToken = localStorage.getItem('access_token');
        
        // Mock Services data (Since services are not database-backed yet)
        const AVAILABLE_SERVICES = [
            { id: 1, name: "Cardio Area Access", description: "Full access to treadmills, ellipticals, and bikes." },
            { id: 2, name: "Strength Training Zone", description: "Access to free weights, racks, and resistance machines." },
            { id: 3, name: "Group Fitness Classes", description: "Unlimited access to yoga, spin, and HIIT classes." },
            { id: 4, name: "Personal Training Sessions", description: "One-on-one sessions with a certified trainer." }
        ];

        // --- DOM Elements ---
        const contentDiv = document.getElementById('main-content');
        const navDiv = document.getElementById('navigation');
        const statusDiv = document.getElementById('auth-status');
        const messageDiv = document.getElementById('message-area');

        // --- UTILITY FUNCTIONS ---
        function showMessage(text, type = 'success') {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }

        async function isAuthenticated() {
            if (!accessToken) {
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                });
                if (response.ok) {
                    currentUser = await response.json();
                    userRole = currentUser.role;
                    return true;
                }
            } catch (error) {
                console.error("Auth check failed:", error);
            }
            // Token is invalid or expired
            logout(false); 
            return false;
        }

        function logout(clearToken = true) {
            if (clearToken) {
                localStorage.removeItem('access_token');
            }
            accessToken = null;
            currentUser = null;
            userRole = null;
            showMessage('Successfully logged out.', 'success');
            renderApp();
        }

        async function handleLogin(email, password) {
            const formBody = new URLSearchParams({ username: email, password: password });
            try {
                const response = await fetch(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formBody
                });
                const data = await response.json();
                
                if (response.ok) {
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    await isAuthenticated(); // Get user details immediately
                    showMessage(`Login successful! Welcome, ${currentUser.name}. Your role is ${userRole}.`, 'success');
                } else {
                    showMessage(`Login failed: ${data.detail || 'Invalid credentials'}`, 'error');
                }
            } catch (error) {
                showMessage(`Network error during login.`, 'error');
            }
            renderApp();
        }

        async function handleRegister(name, email, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await response.json();
                
                if (response.ok) {
                    showMessage(`Registration successful for ${data.email}. You can now log in.`, 'success');
                    renderLogin(); // Switch to login form
                } else {
                    showMessage(`Registration failed: ${data.detail || 'Server error'}`, 'error');
                }
            } catch (error) {
                showMessage(`Network error during registration.`, 'error');
            }
        }
        
        // --- PAGE RENDERERS ---

        function renderNav() {
            navDiv.innerHTML = '';
            if (currentUser) {
                navDiv.innerHTML += `<button onclick="renderServices()">Services</button>`;
                if (userRole === 'admin') {
                    navDiv.innerHTML += `<button onclick="renderAdminDashboard()">Admin Dashboard</button>`;
                }
                navDiv.innerHTML += `<button onclick="logout()">Logout</button>`;
            } else {
                navDiv.innerHTML += `<button onclick="renderLogin()">Login</button>`;
                navDiv.innerHTML += `<button onclick="renderRegister()">Register</button>`;
            }
        }
        
        function updateStatus() {
            if (currentUser) {
                statusDiv.innerHTML = `Logged in as **${currentUser.name}** (${userRole})`;
            } else {
                statusDiv.innerHTML = `Status: Logged Out`;
            }
        }

        function renderLogin() {
            contentDiv.innerHTML = `
                <h2>Login</h2>
                <form id="loginForm">
                    <input type="email" id="login_email" placeholder="Email" required>
                    <input type="password" id="login_password" placeholder="Password" required>
                    <button class="primary" type="submit">Log In</button>
                    <button type="button" onclick="renderRegister()">Need an account? Register here.</button>
                </form>
            `;
            document.getElementById('loginForm').onsubmit = (e) => {
                e.preventDefault();
                handleLogin(
                    document.getElementById('login_email').value,
                    document.getElementById('login_password').value
                );
            };
        }

        function renderRegister() {
             contentDiv.innerHTML = `
                <h2>Register for Membership</h2>
                <form id="registerForm">
                    <input type="text" id="reg_name" placeholder="Full Name" required>
                    <input type="email" id="reg_email" placeholder="Email" required>
                    <input type="password" id="reg_password" placeholder="Password (Min 8 chars)" required>
                    <button class="primary" type="submit">Register</button>
                    <button type="button" onclick="renderLogin()">Already have an account? Log in.</button>
                </form>
            `;
            document.getElementById('registerForm').onsubmit = (e) => {
                e.preventDefault();
                handleRegister(
                    document.getElementById('reg_name').value,
                    document.getElementById('reg_email').value,
                    document.getElementById('reg_password').value
                );
            };
        }

        function renderDashboard() {
            contentDiv.innerHTML = `
                <h2>Welcome to the Gym Portal, ${currentUser ? currentUser.name : 'Guest'}!</h2>
                <p>Your current role is **${userRole || 'Guest'}**.</p>
                
                ${currentUser ? `
                    <p>Access the **Services** tab above to view your membership benefits.</p>
                    ${userRole === 'admin' ? '<p style="color:#3f51b5;">You have **Admin** privileges. Access the Admin Dashboard for management tools.</p>' : ''}
                ` : `
                    <p>Please **Login** or **Register** to access the gym's services.</p>
                `}
            `;
        }

        function renderServices() {
            if (!currentUser) return renderLogin();
            
            let servicesHtml = AVAILABLE_SERVICES.map(service => `
                <div class="service-item">
                    <h4>${service.name}</h4>
                    <p>${service.description}</p>
                </div>
            `).join('');

            contentDiv.innerHTML = `
                <h2>Available Services (${userRole.toUpperCase()} Membership)</h2>
                <p>Here are the services included with your membership:</p>
                <div class="service-list">${servicesHtml}</div>
            `;
        }
        
        function renderAdminDashboard() {
            if (userRole !== 'admin') {
                contentDiv.innerHTML = '<h2>Access Denied</h2><p>You must be an administrator to view this page.</p>';
                return;
            }

            contentDiv.innerHTML = `
                <h2>üëë Admin Dashboard</h2>
                <p>Manage users and mock services here. **Note:** User management endpoints require the user ID.</p>
                
                <h3>User Management (Admin Only)</h3>
                <form id="adminForm" style="border: 1px solid #ccc; padding: 15px;">
                    <input type="number" id="targetUserId" placeholder="Target User ID (e.g., 1)" required>
                    <select id="actionType" required>
                        <option value="">Select Action</option>
                        <option value="get">Get User Details</option>
                        <option value="promote_trainer">Promote to Trainer</option>
                        <option value="promote_admin">Promote to Admin</option>
                    </select>
                    <button type="submit" class="danger">Execute Action</button>
                </form>
            `;
            
            document.getElementById('adminForm').onsubmit = (e) => {
                e.preventDefault();
                handleAdminAction(
                    document.getElementById('targetUserId').value,
                    document.getElementById('actionType').value
                );
            };
        }
        
        async function handleAdminAction(userId, action) {
            if (!accessToken) return showMessage("Log in as Admin first.", "error");

            let method = 'GET';
            let path = '';
            let body = null;
            
            if (action === 'get') {
                path = `/users/${userId}`; // Assuming you have a GET /users/{id} endpoint
                method = 'GET';
            } else if (action.startsWith('promote')) {
                const role = action.split('_')[1];
                path = `/admin/update-role/${userId}`;
                method = 'PATCH';
                body = { role: role };
            } else {
                return showMessage("Invalid action selected.", "error");
            }

            try {
                const response = await fetch(`${API_BASE_URL}${path}`, {
                    method: method,
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': body ? 'application/json' : undefined
                    },
                    body: body ? JSON.stringify(body) : undefined
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage(`Action ${action.toUpperCase()} successful. Response: ${JSON.stringify(data.role || data, null, 2)}`, 'success');
                } else {
                    showMessage(`Action failed (${response.status}): ${data.detail || 'Check user ID or permissions.'}`, 'error');
                }
            } catch (error) {
                showMessage(`Network error during admin action.`, 'error');
            }
        }
        
        // --- APP INITIALIZER ---
        async function renderApp() {
            const loggedIn = await isAuthenticated();
            updateStatus();
            renderNav();
            
            if (loggedIn) {
                renderDashboard();
            } else {
                renderLogin();
            }
        }

        // Start the application
        renderApp();
    </script>
</body>
</html>